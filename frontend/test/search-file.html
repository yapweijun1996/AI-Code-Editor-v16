<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test: Search & File Ops (search_in_file, read_file_lines, rename_file)</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#151820;--text:#e6e6e6;--muted:#9aa4b2;--accent:#3b82f6;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;--border:#232838;--code:#0b0e14;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{padding:20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(59,130,246,0.10),transparent 60%)}
    h1{margin:0 0 6px;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}
    main{max-width:1100px;margin:0 auto;padding:20px}
    a.back{display:inline-block;margin:8px 0 14px;color:#93c5fd;text-decoration:none;font-size:13px}
    a.back:hover{text-decoration:underline}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    .panel h2{font-size:16px;margin:0 0 8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .row input[type="text"], .row input[type="number"], .row textarea{
      background:#0f131c;border:1px solid var(--border);color:#e5e7eb;border-radius:8px;padding:8px;font-size:13px;width:100%
    }
    .row .half{flex:1 1 48%}
    .row .third{flex:1 1 30%}
    .row textarea{height:140px;resize:vertical}
    .btn{
      display:inline-block;text-decoration:none;border:1px solid rgba(59,130,246,0.35);
      background:rgba(59,130,246,0.15);color:#dbeafe;padding:8px 12px;border-radius:8px;font-size:14px;cursor:pointer
    }
    .btn:hover{background:rgba(59,130,246,0.25)}
    .btn-secondary{border-color:rgba(148,163,184,0.35);background:rgba(148,163,184,0.12);color:#e5e7eb}
    .btn-ok{border-color:rgba(16,185,129,0.4);background:rgba(16,185,129,0.15);color:#d1fae5}
    .btn-warn{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.15);color:#fde68a}
    .status{font-size:12px;margin-top:8px}
    .status.ok{color:#86efac}
    .status.err{color:#fca5a5}
    .code{
      background:var(--code);border:1px solid var(--border);border-radius:8px;padding:10px;
      white-space:pre-wrap;color:#cbd5e1;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px
    }
    .note{color:var(--muted);font-size:12px;margin-top:8px}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>Search & File Operations Test</h1>
  <div class="subtitle">Manual tests for search_in_file, read_file_lines, and rename_file using the browser File System Access API.</div>
</header>

<main>
  <a class="back" href="./index.html">&#8592; Back to Test Listing</a>

  <section class="panel" id="picker">
    <h2>Project Root</h2>
    <div class="row">
      <button id="btnPickRoot" class="btn">Choose Directory...</button>
      <button id="btnForgetRoot" class="btn btn-secondary">Forget Permission</button>
    </div>
    <div id="rootStatus" class="status">Root: not selected</div>
    <div class="note">
      Choose your project root directory to enable operations. Permissions are scoped to this browser.
    </div>
  </section>

  <div class="grid">
    <section class="panel" id="searchPanel">
      <h2>search_in_file</h2>
      <div class="row">
        <input id="searchPath" type="text" placeholder="Relative file path (e.g., frontend/js/tool_executor.js)"/>
      </div>
      <div class="row">
        <input id="searchPattern" type="text" placeholder="Pattern to search (literal). For regex, toggle below."/>
      </div>
      <div class="row">
        <label class="note"><input type="checkbox" id="searchRegex"/> Use regex</label>
        <label class="note"><input type="checkbox" id="searchIgnoreCase" checked/> Ignore case</label>
      </div>
      <div class="row">
        <button id="btnSearch" class="btn">Search</button>
      </div>
      <div id="searchStatus" class="status"></div>
      <div id="searchOutput" class="code" style="margin-top:8px;max-height:340px;overflow:auto"></div>
      <div class="note">Displays matching lines with line numbers and small context window.</div>
    </section>

    <section class="panel" id="linesPanel">
      <h2>read_file_lines</h2>
      <div class="row">
        <input id="linesPath" class="half" type="text" placeholder="Relative file path (e.g., README.md)"/>
        <input id="startLine" class="third" type="number" min="1" placeholder="Start line"/>
        <input id="endLine" class="third" type="number" min="1" placeholder="End line"/>
      </div>
      <div class="row">
        <button id="btnReadLines" class="btn">Read Lines</button>
      </div>
      <div id="linesStatus" class="status"></div>
      <div id="linesOutput" class="code" style="margin-top:8px;max-height:340px;overflow:auto"></div>
      <div class="note">Outputs the selected line range, inclusive.</div>
    </section>
  </div>

  <section class="panel" id="renamePanel" style="margin-top:16px">
    <h2>rename_file</h2>
    <div class="row">
      <input id="renameOld" class="half" type="text" placeholder="Old path (e.g., tmp/a.txt)"/>
      <input id="renameNew" class="half" type="text" placeholder="New path (e.g., tmp/b.txt)"/>
    </div>
    <div class="row">
      <button id="btnRename" class="btn btn-ok">Rename / Move</button>
    </div>
    <div id="renameStatus" class="status"></div>
    <div class="note">Implemented via copy+delete using the File System Access API to simulate rename.</div>
  </section>

  <section class="panel" id="logPanel" style="margin-top:16px">
    <h2>Log</h2>
    <div id="log" class="code" style="max-height:220px;overflow:auto"></div>
  </section>
</main>

<script>
(function(){
  let rootHandle = null;

  const el = id => document.getElementById(id);
  const log = (...args) => {
    const msg = args.map(a => typeof a === 'string' ? a : JSON.stringify(a, null, 2)).join(' ');
    const at = new Date().toLocaleTimeString();
    const logEl = el('log');
    logEl.textContent += '[' + at + '] ' + msg + '\\n';
    logEl.scrollTop = logEl.scrollHeight;
  };
  const setStatus = (id, text, type='') => {
    const s = el(id);
    s.textContent = text || '';
    s.className = 'status' + (type ? ' ' + type : '');
  };
  const showRoot = () => setStatus('rootStatus', rootHandle ? 'Root: permission granted' : 'Root: not selected');

  async function verifyPermission(handle, opts = { mode: 'readwrite' }) {
    if ((await handle.queryPermission(opts)) === 'granted') return true;
    if ((await handle.requestPermission(opts)) === 'granted') return true;
    return false;
  }

  async function getDirectoryHandleFromParts(parts, create=false) {
    let current = rootHandle;
    for (const p of parts) {
      current = await current.getDirectoryHandle(p, { create });
    }
    return current;
  }

  async function getFileHandleByPath(pathStr, create=false) {
    const parts = pathStr.split('/').filter(Boolean);
    if (parts.length === 0) throw new Error('Invalid path');
    const filename = parts.pop();
    const parent = await getDirectoryHandleFromParts(parts, create);
    const fh = await parent.getFileHandle(filename, { create });
    return fh;
  }

  function toLines(text) {
    return text.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n').split('\\n');
  }

  // search_in_file implementation (client-side)
  el('btnSearch').addEventListener('click', async () => {
    setStatus('searchStatus', '');
    el('searchOutput').textContent = '';
    try{
      if (!rootHandle) throw new Error('Select a root directory first.');
      const filePath = (el('searchPath').value || '').trim();
      const pattern = (el('searchPattern').value || '').trim();
      const useRegex = el('searchRegex').checked;
      const ignoreCase = el('searchIgnoreCase').checked;
      if (!filePath) throw new Error('Please enter a file path.');
      if (!pattern) throw new Error('Please enter a pattern.');

      log('search_in_file:', JSON.stringify({ filename: filePath, pattern, useRegex, ignoreCase }));
      const fh = await getFileHandleByPath(filePath, false);
      const text = await (await fh.getFile()).text();
      const lines = toLines(text);

      let matcher;
      if (useRegex) {
        const flags = ignoreCase ? 'i' : '';
        matcher = (s) => new RegExp(pattern, flags).test(s);
      } else {
        const needle = ignoreCase ? pattern.toLowerCase() : pattern;
        matcher = (s) => (ignoreCase ? s.toLowerCase() : s).includes(needle);
      }

      const context = 1;
      const out = [];
      for (let i = 0; i < lines.length; i++) {
        if (matcher(lines[i])) {
          // include context
          const start = Math.max(0, i - context);
          const end = Math.min(lines.length - 1, i + context);
          for (let j = start; j <= end; j++) {
            out.push(String(j+1).padStart(5, ' ') + ' | ' + lines[j]);
          }
          out.push('-----');
        }
      }
      el('searchOutput').textContent = out.length ? out.join('\\n') : '(no matches)';
      setStatus('searchStatus', 'Search completed', 'ok');
    }catch(e){
      setStatus('searchStatus', e.message || String(e), 'err');
      log('search_in_file error:', e.message || e);
    }
  });

  // read_file_lines implementation (client-side)
  el('btnReadLines').addEventListener('click', async () => {
    setStatus('linesStatus', '');
    el('linesOutput').textContent = '';
    try{
      if (!rootHandle) throw new Error('Select a root directory first.');
      const filePath = (el('linesPath').value || '').trim();
      const sLine = parseInt(el('startLine').value, 10);
      const eLine = parseInt(el('endLine').value, 10);
      if (!filePath) throw new Error('Please enter a file path.');
      if (!Number.isFinite(sLine) || !Number.isFinite(eLine) || sLine < 1 || eLine < sLine) {
        throw new Error('Please provide valid start and end line numbers (1-based, end >= start).');
      }

      log('read_file_lines:', JSON.stringify({ filename: filePath, start_line: sLine, end_line: eLine }));
      const fh = await getFileHandleByPath(filePath, false);
      const text = await (await fh.getFile()).text();
      const lines = toLines(text);

      const startIdx = Math.max(0, Math.min(lines.length, sLine) - 1);
      const endIdx = Math.max(0, Math.min(lines.length, eLine) - 1);
      const out = [];
      for (let i = startIdx; i <= endIdx; i++) {
        out.push(String(i+1).padStart(5, ' ') + ' | ' + lines[i]);
      }
      el('linesOutput').textContent = out.length ? out.join('\\n') : '(no lines in range)';
      setStatus('linesStatus', `Read lines ${sLine}-${eLine}`, 'ok');
    }catch(e){
      setStatus('linesStatus', e.message || String(e), 'err');
      log('read_file_lines error:', e.message || e);
    }
  });

  // rename_file implementation (copy + delete)
  el('btnRename').addEventListener('click', async () => {
    setStatus('renameStatus', '');
    try{
      if (!rootHandle) throw new Error('Select a root directory first.');
      const oldPath = (el('renameOld').value || '').trim();
      const newPath = (el('renameNew').value || '').trim();
      if (!oldPath || !newPath) throw new Error('Please provide both old and new paths.');
      if (oldPath === newPath) throw new Error('Old and new paths are identical.');

      log('rename_file:', JSON.stringify({ old_path: oldPath, new_path: newPath }));

      // Read old file
      const oldFH = await getFileHandleByPath(oldPath, false);
      const oldBlob = await (await oldFH.getFile()).text();

      // Ensure parent dirs for new path
      const parts = newPath.split('/').filter(Boolean);
      const filename = parts.pop();
      const parent = await getDirectoryHandleFromParts(parts, true);
      const newFH = await parent.getFileHandle(filename, { create: true });

      // Write content to new file
      const writable = await newFH.createWritable();
      await writable.write(oldBlob);
      await writable.close();

      // Delete old file
      // Need directory handle of old file
      const oldParts = oldPath.split('/').filter(Boolean);
      const oldName = oldParts.pop();
      const oldParent = await getDirectoryHandleFromParts(oldParts, false);
      await oldParent.removeEntry(oldName);

      setStatus('renameStatus', 'Rename completed', 'ok');
    }catch(e){
      setStatus('renameStatus', e.message || String(e), 'err');
      log('rename_file error:', e.message || e);
    }
  });

  // Picker
  el('btnPickRoot').addEventListener('click', async () => {
    try{
      rootHandle = await window.showDirectoryPicker({ id: 'ai-ide-root' });
      const ok = await verifyPermission(rootHandle, { mode: 'readwrite' });
      if (!ok) throw new Error('Permission not granted');
      showRoot();
      log('Selected root directory.');
    }catch(e){
      log('Failed to select root:', e.message || e);
      setStatus('rootStatus', 'Root selection failed: ' + (e.message || e), 'err');
    }
  });
  el('btnForgetRoot').addEventListener('click', () => {
    rootHandle = null;
    showRoot();
    log('Cleared root handle reference. To fully revoke, clear site data in your browser.');
  });

  // init
  showRoot();
})();
</script>
</body>
</html>